#!/bin/sh

HELP_MENU='To activate or disactivate the TV-out mode without using this menu, you can use the shortcut POWER+Y.\n\n
VSYNC, when activated, ensures a perfect picture quality.
Disabling VSYNC may result in a higher FPS, at the cost of picture quality.'
HELP_MODE='Choose the signal type that your television accepts:\n
\n
- NTSC is used in the Philippines, Japan, and all American countries, except in Brazil, Argentina, Paraguay and Uruguay.\n
\n
- PAL-M is used only in Brazil.\n
\n
- PAL-60 is used on all other countries.\n
\n
- PAL (50Hz) is for legacy TVs only.'

SYS_FILE="/sys/devices/platform/jz4740-fb/tv_out"

SYSTEM_CONF_FILE="/etc/tvout.conf"
. $SYSTEM_CONF_FILE

CONF_FILE="/etc/local/tvout.conf"
if [ -f "$CONF_FILE" ]; then
	. $CONF_FILE
else
	( echo "# TV-out configuration file." ;
	echo "# Generated by tvout_config" ) > $CONF_FILE
fi

while /bin/true; do
	CONF_FILE_CONTENT=`cat "$CONF_FILE"`

	if [ "x`cat $SYS_FILE`" = "xoff" ]; then
		ONOFF='on'
		ONOFF_LABEL='Enable TV-out'
	else
		ONOFF='off'
		ONOFF_LABEL='Disable TV-out'
	fi

	if [ $TV_VSYNC -eq 1 ]; then
		VSYNC_LABEL='Disable VSYNC'
	else
		VSYNC_LABEL='Enable VSYNC'
	fi

	MODE=`dialog --stdout --help-button --menu 'Choose an action.' 10 50 4 'mode' 'Switch PAL/NTSC' 'vsync' "$VSYNC_LABEL" 'toggle' "$ONOFF_LABEL"`

	case $MODE in
		"")
			exit 1
			;;

		HELP*)
			dialog --msgbox "$HELP_MENU" 12 50
			;;

		mode)
			while /bin/true; do
				VALUE=`dialog --stdout --help-button --menu \
					"Choose your TV type (current: $TV_NORM)" 11 50 5 \
					'ntsc' 'Your TV is NTSC' \
					'pal-60' 'Your TV is PAL (60Hz)' \
					'pal' 'Your TV is PAL (50Hz)' \
					'pal-m' 'Your TV is PAL-M (Brazil)'`

				case "$VALUE" in
					"")
						break;
						;;

					HELP*)
						dialog --msgbox "$HELP_MODE" 18 50
						;;

					*)
						TV_NORM="$VALUE"
						break;
				esac
			done

			# Update config.
			(echo "$CONF_FILE_CONTENT" |grep -v "TV_NORM" ; echo -n "TV_NORM=$TV_NORM") > $CONF_FILE
			;;

		vsync)
			# Update config.
			if [ "$TV_VSYNC" -eq 1 ]; then
				TV_VSYNC=0
			else
				TV_VSYNC=1
			fi
			(echo "$CONF_FILE_CONTENT" |grep -v "TV_VSYNC" ; echo -n "TV_VSYNC=$TV_VSYNC") > $CONF_FILE
			;;

		toggle)
			tvtool --$ONOFF
			exit 0
			;;

		*)
			exit 1
	esac
done
